<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Extension Proxy</title>
</head>
<body>
  <div id="status">Extension proxy loaded</div>
  
  <script>
    // Listen for messages from the extension
    window.addEventListener('message', async function(event) {
      // For security, you might want to check the origin
      // but for your testing purposes, I'm leaving it open
      
      try {
        const request = event.data;
        console.log('Received request from extension:', request);
        
        if (!request || !request.type || request.type !== 'API_REQUEST') {
          throw new Error('Invalid request format');
        }
        
        const { endpoint, method, data, headers } = request;
        
        // Make the API request from this page (which shares origin with your backend)
        const fetchOptions = {
          method: method || 'GET',
          headers: headers || {
            'Content-Type': 'application/json'
          },
          credentials: 'include'
        };
        
        if (data && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
          fetchOptions.body = JSON.stringify(data);
        }
        
        const response = await fetch(endpoint, fetchOptions);
        const responseData = await response.json().catch(() => ({}));
        
        // Send the response back to the extension
        event.source.postMessage({
          type: 'API_RESPONSE',
          id: request.id,
          success: response.ok,
          status: response.status,
          data: responseData
        }, '*');
        
      } catch (error) {
        console.error('Error handling extension request:', error);
        
        // Send error back to extension
        if (event.source) {
          event.source.postMessage({
            type: 'API_RESPONSE',
            id: event.data?.id,
            success: false,
            error: error.message
          }, '*');
        }
      }
    });
    
    // Let extension know we're ready
    window.addEventListener('load', function() {
      document.getElementById('status').textContent = 'Extension proxy ready';
      
      // Broadcast ready message to any extension frames that might be listening
      window.parent.postMessage({ type: 'PROXY_READY' }, '*');
    });
  </script>
</body>
</html>